```{r}
library(NMF)
library(stringr)
# library(eoffice)
library(dplyr)
library(ComplexHeatmap)
library(ggplot2)
# library(rJava)
# library(xlsx)
# library(RColorBrewer)
library(circlize)
library(umap)
library(Rtsne)
library(ggrepel)
library(ggplot2)
library(clusterProfiler)
library(KEGGREST)
library(ConsensusClusterPlus)
library(viridis)
library(survminer)
library(survival)
library(gridExtra)


getwd()
source('~/workstation/MetabSubtype/tasks/MultiOmics/notebooks/utils.R')

```

# Prepare Data

## Preprocess

-   Log

-   Delete Odd Chain

-   Scale

```{r}

##### Metab #####
LABEL_NUM=0
filepath.metab='~/workstation/MetabSubtype/tasks/Subtype/data/Using/lipid.csv'
filepath.sample='~/workstation/MetabSubtype/tasks/Subtype/data/Using/sample.csv'
df.metab<-read.csv(filepath.metab, header= TRUE, check.names=F,row.names=1)
dim(df.metab)
df.sample<-read.csv(filepath.sample, header= TRUE, check.names=F)
length(unique((df.metab[,1])))
df.metab[df.metab=='']=NA
dim(df.metab)

df.sample[df.sample=='']=NA
df.sample[df.sample=='Neg']=NA
# df.sample=df.sample[!is.na(df.sample['Sample Name']),c('Sample Name','主要分型','生存时间分组','MT2结构')]
df.sample=df.sample[!is.na(df.sample['Sample Name']),]
row.names(df.sample)=df.sample[['Sample Name']]
df.sample=df.sample[rownames(df.metab),]
df.sample[match('1520',rownames(df.sample)),'oss']=0
dim(df.metab)
metab_num=ncol(df.metab)
df.raw_metab=df.metab[,1:metab_num]
dim(df.sample)
dim(merge(df.metab,df.sample,by.x="row.names",by.y="Sample Name"))
# Odd Chain
dim(df.raw_metab)
df.raw_metab=drop_odd_chain_cols(df.raw_metab)
dim(df.raw_metab)
metab_num=dim(df.raw_metab)[2]
# Normalize Data
df.raw_metab.log=log2(df.raw_metab)
df.raw_metab.scaled=df.raw_metab.log
raw_metab_mean=apply(df.raw_metab.log,1,mean)
raw_metab_std=apply(df.raw_metab.log,1,sd)
df.raw_metab.scaled=(df.raw_metab.scaled-raw_metab_mean)/raw_metab_std
# df.raw_metab.scaled=as.data.frame(nneg(as.matrix(df.raw_metab.scaled),method='min'))
colnames(df.raw_metab.scaled)
dim(df.raw_metab.scaled)
```

## Consensus Clustering

```{r}
rcc = ConsensusClusterPlus(data.matrix(df.raw_metab.scaled), 
                           maxK = 8, 
                           reps = 1000, 
                           pItem = 0.8, 
                           pFeature = 1,
                           clusterAlg = "km",
                           plot="pdf")
```

## Dimension Reduction

### PCA

```{r}
colnames(df.raw_metab.scaled)[ncol(df.raw_metab.scaled)]
```

```{r}
pca.lipid=prcomp(df.raw_metab.scaled,scale.=TRUE)
summary(pca.lipid)

```

```{r}

df.metab.pca=pca.lipid$x
using_num=49
df.metab.pca=df.metab.pca[,1:using_num]
df.metab.pca=as.data.frame(nneg(as.matrix(df.metab.pca),method='min'))
```

# Bubble Fig

## Stat

```{r}
##### Draw ######
class_label='kmeans_2_clusters'
df.use_sample=df.sample
df.use=merge(df.raw_metab,df.cluster_result[,class_label,drop=FALSE],by="row.names")
row.names(df.use)=df.use[[1]]
df.use=df.use[,2:ncol(df.use)]

volcano.test.results=pvalue_by_wilcox(df.use,metab_num,class_label)

type1='1'
type2='2'
volcano.test.results$FC=apply(df.use[,1:metab_num], 2, 
                              function(x) 
                                mean(as.numeric(x[which(df.use[class_label] == type2)]))/
                                mean(as.numeric(x[which(df.use[class_label] == type1)])))
head(volcano.test.results)
# Log2 (FC)
volcano.test.results$log2FC <- log2(volcano.test.results[,'FC'])

pvalue_cutoff=5e-2
fc_up_cutoff=3/2
draw_volcano(volcano.test.results,pvalue_cutoff,fc_up_cutoff)

```

## Draw

```{r}



lipo.bubble %>%
  arrange(desc(`FDR`)) %>%
  ggplot(aes(x=number, y=`Log2 (FC) relative to Ctrl`, size=`FDR`, color=`lipid species`)) +
  geom_point(alpha=0.4) +
  scale_size(range = c(0.1, 3.5), name="Population (M)" +
               scale_fill_viridis(discrete=TRUE, guide=FALSE, option="A"))+
  theme(plot.title = element_text( size = 6, vjust = 6, hjust = 0.5, face = "plain"), 
        axis.title.x = element_text(size = 6, vjust = -2, hjust = 0.55, face = "plain"), 
        axis.title.y = element_text(size = 6, vjust = 2, face = "plain"),
        axis.text.x = element_text(size = 6, face = "plain", colour = "black"), 
        axis.text.y = element_text(size = 6, face = "plain", colour = "black"),
        legend.title = element_text(size = 6, face = "plain", colour = "black"),
        legend.text = element_text(size = 2), 
        legend.key.size = unit(0.1, "cm"), 
        legend.spacing = unit(0.1, "cm"))+
  theme_bw() +
  theme(plot.margin = margin(1, 1, 1, 1, "cm"), aspect.ratio = 0.45)+
  geom_hline(yintercept = c(-0.58,0.58),lty=4,col="black",lwd=0.4)
```

# Clustering

```{r}

df.use=df.metab.pca
# df.use=df.raw_metab.scaled

set.seed(120)
nmf_k=3
kmeans_k=3
df.cluster_result=perform_clustering(df.use, metab_num=ncol(df.use),nmf_k, kmeans_k)
df.cluster_result.correction=df.cluster_result

dim(df.cluster_result)
dim(df.use)

```

```{r}
df.cluster_result.correction
```

## Survival Test

```{r fig.height=6, fig.width=8}

df.use=df.metab.pca

# 1203948 321
set.seed(321)
nmf_k=3
kmeans_k=3
df.cluster_result=perform_clustering(df.use, metab_num=ncol(df.use),nmf_k, kmeans_k)
df.cluster_result.correction=df.cluster_result

dim(df.cluster_result)
dim(df.use)

time_label_col='os'
event_label_col=paste0(time_label_col,'s')
##### Survival #####
df.use.os=merge(df.cluster_result.correction,df.sample[,c(time_label_col,event_label_col)],by='row.names')
df.use.os=df.use.os[order(df.use.os[[time_label_col]]),,drop=FALSE]
# df.use.os=df.use.os[1:(nrow(df.use.os)-1),]
surv_object=Surv(df.use.os[[time_label_col]],df.use.os[[event_label_col]])
# K-MEANS
kmeans_fit=survfit(surv_object~kmeans_2_clusters,data=df.use.os)
kmeans_plot=ggsurvplot(kmeans_fit, data = df.use.os,pval = TRUE,risk.table = TRUE)
pdf("~/workstation/MetabSubtype/tasks/MultiOmics/notebooks/lipid_kmeans_survival.pdf")
# ggsave(file="~/workstation/MetabSubtype/tasks/MultiOmics/notebooks/lipid_kmeans_survival.pdf",print(kmeans_plot)) # It's not working. Why?
print(kmeans_plot$plot,newpage = FALSE)
# NMF
nmf_fit=survfit(surv_object~nmf_2_clusters,data=df.use.os)
nmf_plot=ggsurvplot(nmf_fit, data = df.use.os,pval = TRUE,risk.table = TRUE)
# nmf_plot
# Combine
arrange_ggsurvplots(list(kmeans_plot,nmf_plot),ncol=2,nrow=1, data = df.use.os,pval = TRUE,title=toupper(time_label_col))
dev.off()

```

## Save Result

```{r}
df.sample_cluster=merge(df.sample,df.cluster_result.correction,by="row.names")
row.names(df.sample_cluster)=df.sample_cluster[[1]]
df.sample_cluster=df.sample_cluster[,2:ncol(df.sample_cluster)]
filepath.cluster='~/workstation/MetabSubtype/tasks/MultiOmics/results/20240815/lipid_cluster_1e-2.csv'
#
# write.csv(df.sample_cluster,filepath.cluster)
#
```

# Analysis

## Heatmap

```{r fig.height=8, fig.width=8}

df.use=merge(df.raw_metab.scaled,df.cluster_result.correction,by="row.names")
row.names(df.use)=df.use[[1]]
df.use=df.use[,2:ncol(df.use)]

dim(df.use)
p_cutoff=5e-2

draw_single_heatmap(df.use,metab_num,'kmeans_3_clusters',p_cutoff,TRUE)
draw_single_heatmap(df.use,metab_num,'nmf_3_clusters',p_cutoff,TRUE )
draw_single_heatmap(df.use,metab_num,'kmeans_2_clusters',p_cutoff,TRUE )
draw_single_heatmap(df.use,metab_num,'nmf_2_clusters',p_cutoff,TRUE )
```

```{r}
pdf("lipid_kmeans_2_sig_heatmap.pdf")
draw_single_heatmap(df.use,metab_num,'kmeans_2_clusters',5e-2,TRUE )
dev.off()
pdf("lipid_kmeans_2_all_heatmap.pdf")
draw_single_heatmap(df.use,metab_num,'kmeans_2_clusters',1,TRUE )
dev.off()
```

## Survival

```{r fig.height=6, fig.width=10}

time_label_col='os'
event_label_col=paste0(time_label_col,'s')
##### Survival #####
df.use.os=merge(df.cluster_result.correction,df.sample[,c(time_label_col,event_label_col)],by='row.names')
df.use.os=df.use.os[order(df.use.os[[time_label_col]]),,drop=FALSE]

surv_object=Surv(df.use.os[[time_label_col]],df.use.os[[event_label_col]])

# K-MEANS
kmeans_fit=survfit(surv_object~kmeans_2_clusters,data=df.use.os)
kmeans_plot=ggsurvplot(kmeans_fit, data = df.use.os,pval = TRUE,risk.table = TRUE)
# NMF
nmf_fit=survfit(surv_object~nmf_2_clusters,data=df.use.os)
nmf_plot=ggsurvplot(nmf_fit, data = df.use.os,pval = TRUE,risk.table = TRUE)
# nmf_plot
# Combine
arrange_ggsurvplots(list(kmeans_plot,nmf_plot),ncol=2,nrow=1, data = df.use.os,pval = TRUE,title=toupper(time_label_col))


# K-MEANS
kmeans_fit=survfit(surv_object~kmeans_3_clusters,data=df.use.os)
kmeans_plot=ggsurvplot(kmeans_fit, data = df.use.os,pval = TRUE,risk.table = TRUE)
# NMF
nmf_fit=survfit(surv_object~nmf_3_clusters,data=df.use.os)
nmf_plot=ggsurvplot(nmf_fit, data = df.use.os,pval = TRUE,risk.table = TRUE)
# nmf_plot
# Combine
arrange_ggsurvplots(list(kmeans_plot,nmf_plot),ncol=2,nrow=1, data = df.use.os,pval = TRUE,title=toupper(time_label_col))

```

## Lipid Bubble

### Stat

```{r}

class_label='kmeans_2_clusters'
df.use_sample=df.cluster_result
df.use=merge(df.raw_metab.scaled,df.cluster_result.correction[,class_label,drop=FALSE],by="row.names")
row.names(df.use)=df.use[[1]]
df.use=df.use[,2:ncol(df.use)]

volcano.test.results=pvalue_by_wilcox(df.use,metab_num,class_label)
volcano.test.results$FDR=p.adjust(volcano.test.results$pvalue,method="BH")

type1='1'
type2='2'
volcano.test.results$FC=apply(df.use[,1:metab_num], 2, 
                              function(x) 
                                mean(as.numeric(x[which(df.use[class_label] == type2)]))/
                                mean(as.numeric(x[which(df.use[class_label] == type1)])))
head(volcano.test.results)
# Log2 (FC)
volcano.test.results$log2FC <- log2(volcano.test.results[,'FC'])

volcano.test.results


volcano.test.results$lipid_class=sapply(volcano.test.results$Metabolites,function(col)
{str_extract(col,'([A-Z]*[a-z]*)*')})

```

### Draw

```{r}

table(volcano.test.results$lipid_class)
sum(table(volcano.test.results$lipid_class))
# write.csv(volcano.test.results,"~/workstation/MetabSubtype/tasks/MultiOmics/results/20240523_summary/lipid_stat.csv")
# volcano.test.results$lipid_class

# Test Stored Volcano
# volcano.test.results=read.csv("~/workstation/MetabSubtype/tasks/MultiOmics/results/20240523_summary/lipid_stat.csv",row.names = 1)
```

```{r}
# pdf("lipid_bubble.pdf")
lipo.bubble=volcano.test.results
lipo.bubble %>%
  filter(lipid_class %in% c('Cer','Hex','LPC','LPE','SM','PC','PE','PG','PI','PS','TAG','DAG','TG')) %>%
  arrange(desc(`FDR`)) %>%
  ggplot(aes(x=lipid_class, y=log2FC, size=-log10(FDR), color=lipid_class)) +
  # geom_point(alpha=0.4) +
  geom_jitter(alpha=0.4,width = 0.4)+
  scale_size(range = c(0.1, 3.5), name="-Log(P)" 
             +
               scale_fill_viridis(discrete=TRUE, guide=TRUE, option="A")
               )+
  theme(plot.title = element_text( size = 6, vjust = 6, hjust = 0.5, face = "plain"), 
        axis.title.x = element_text(size = 6, vjust = -2, hjust = 0.55, face = "plain"), 
        axis.title.y = element_text(size = 10, vjust = 2, face = "plain"),
        axis.text.x = element_text(size = 10, face = "plain", colour = "black"), 
        axis.text.y = element_text(size = 6, face = "plain", colour = "black"),
        legend.title = element_text(size = 6, face = "plain", colour = "black"),
        legend.text = element_text(size = 10), 
        legend.key.size = unit(0.1, "cm"), 
        legend.spacing = unit(0.1, "cm"))+
  # theme_bw() +
  # theme(plot.margin = margin(1, 1, 1, 1, "cm"), aspect.ratio = 0.45)+
  # theme(axis.title.x=element_blank(),
  #       axis.text.x=element_blank(),
  #       axis.ticks.x=element_blank())+
  geom_hline(yintercept = c(-log2(1.2),log2(1.2)),lty=4,col="black",lwd=0.4)
# dev.off()
```

## Boxplot

```{r}
class_label='kmeans_2_clusters'
df.grep_lipid=get_grep_df(df.raw_metab.scaled,metab_num)
use_num=ncol(df.grep_lipid)
df.use=merge(df.grep_lipid,df.cluster_result.correction[,c(class_label),drop=FALSE],by="row.names")
rownames(df.use)=df.use[[1]]
df.use=df.use[,2:ncol(df.use)]
df.use[class_label]=as.factor(df.use[[class_label]])
# Calculate p-value
df.use[[class_label]]
pvalues=sapply(X=(colnames(df.use)[1:use_num]),FUN=function(feature){
  print(feature)
    wilcox.test(df.use[[feature]] ~ df.use[[class_label]],exact=FALSE)$p.value
})
pvalues
significant_headgroups=names(pvalues[pvalues<=5e-2])
headgroups=names(pvalues[pvalues<=1e-1])
significant_headgroups
headgroups
df.use[class_label]
# draw_boxplot(df.use,significant_headgroups[1],class_label)
# draw_boxplot(df.use,significant_headgroups[2],class_label)
# draw_boxplot(df.use,headgroups[1],class_label)

significant_headgroups=c('Cer','TG','LPC')

for (headgroup in significant_headgroups){
  filepath.box_plot=paste0("lipid_",headgroup,"_boxplot.pdf")
  pdf(filepath.box_plot)
  draw_boxplot(df.use,headgroup,class_label,is_scale=TRUE)

  dev.off()
}

```

```{r}
rownames(df.grep_lipid)
```
