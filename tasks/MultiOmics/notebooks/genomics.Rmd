# Prepare Data

## Keytypes

```{r}
df.test_results=data.frame(ENSEMBL=colnames(v_corrected.edger))
tmp_key=bitr(df.test_results[['ENSEMBL']], #数据集
  fromType="ENSEMBL", #输入为SYMBOL格式
  toType="SYMBOL",  # 转为ENTERZID格式
  OrgDb="org.Hs.eg.db") #人类 数据库

matched_indices <- match(df.test_results$ENSEMBL, tmp_key$ENSEMBL)
df.test_results$SYMBOL <- tmp_key$SYMBOL[matched_indices]

tmp_key=bitr(df.test_results[['ENSEMBL']], #数据集
  fromType="ENSEMBL", #输入为SYMBOL格式
  toType="ENTREZID",  # 转为ENTERZID格式
  OrgDb="org.Hs.eg.db") #人类 数据库
matched_indices <- match(df.test_results$ENSEMBL, tmp_key$ENSEMBL)
df.test_results$ENTREZID <- tmp_key$ENTREZID[matched_indices]
```

```{r}
ENSG00000132915
v_corrected.edger[,'ENSG00000132915']

```

## Non-Coding

```{r}

# Patterns to match
patterns <- c('.+-P$', '.+-AS', '\\d{4,}', '^(MI|AC|LINC)', 'RNU-')

# Check if column matches any patterns
keep.symbols <- character()
length(df.test_results[['SYMBOL']])
symbols=df.test_results[!is.na(df.test_results['SYMBOL']),'SYMBOL']
pb=progress_bar$new(total=length(symbols))
for (symbol in symbols) {
  pb$tick()
  if (!any(sapply(patterns, function(p) str_detect(symbol, p)))) {
    keep.symbols <- c(keep.symbols, df.test_results[df.test_results$SYMBOL==symbol,'ENSEMBL'])
  }
}
length(keep.symbols[!is.na(keep.symbols)])
df.cpm.coding=df.cpm[,keep.symbols]
dim(df.cpm.coding)
keep.symbols=keep.symbols[!is.na(keep.symbols)]
df.test_results$CODING=0
df.test_results[df.test_results$ENSEMBL %in% keep.symbols,'CODING']=1

# write.csv(df.test_results,"~/workstation/MetabSubtype/tasks/MultiOmics/data/rna/rna_info.csv")
rownames(df.test_results)=df.test_results$ENSEMBL
# df.test_results=merge(df.test_results,df.pathway_fc,by.x="ENSEMBL",by.y="row.names")
```

```{r}
sapply(patterns, function(p) str_detect(symbol, p))
```

# KEGG

```{r}


logfc_cutoff=log2(2)
pvalue_cutoff=5e-2
df.test_results$is_use=(df.test_results$pvalue<=pvalue_cutoff)&(abs(df.test_results$log2fc)>=logfc_cutoff)
entrezid.sig=df.test_results[df.test_results$is_use,'ENTREZID']
entrezid.sig=entrezid.sig[!is.na(entrezid.sig)]
length(entrezid.sig)

entrezid.universe=df.test_results[['ENTREZID']]
entrezid.universe=entrezid.universe[!is.na(entrezid.universe)]
length(entrezid.universe)

df.test_results.up=df.test_results[df.test_results$log2fc>0,]
df.test_results.down=df.test_results[df.test_results$log2fc<0,]


kegg_result=enrichKEGG(
  entrezid.sig,
  organism = "hsa",
  keyType = "kegg",
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  minGSSize = 1,
  maxGSSize = 500,
  qvalueCutoff = 0.2,
  universe = entrezid.universe,
  use_internal_data = FALSE
)
kegg_table <- na.omit(as.data.frame(kegg_result))

kegg_table$FoldEnrich <- apply(kegg_table, 1, 
                               function(x) as.numeric(unlist(strsplit(x[['GeneRatio']], '[/]'))[1])/
                                 as.numeric(unlist(strsplit(x[['GeneRatio']], '[/]'))[2])*
                                 as.numeric(unlist(strsplit(x[['BgRatio']], '[/]'))[2])/
                                 as.numeric(unlist(strsplit(x[['BgRatio']], '[/]'))[1]))
kegg_table$symbol=apply(kegg_table,1,get_symbols)
```

```{r}
length(entrezid.sig)
writeLines(entrezid.sig, "entrezid_sig.txt")
```

# GSEA

```{r}


pathway_name='methionine'
pathway_id <- "hsa00270"
# 获取通路信息
pathway_info <- keggGet(pathway_id)
# 提取基因信息
genes <- pathway_info[[1]]$GENE
# 将基因ID和名称分离
gene_ids <- genes[seq(1, length(genes), 2)]
gene_names <- genes[seq(2, length(genes), 2)]

using.test_results=df.test_results[df.test_results$ENTREZID %in% gene_ids,]
using.test_results=df.test_results
foldchanges=using.test_results[,'fc']
names(foldchanges)=using.test_results[,'ENTREZID']
# gene_list<-na.omit(gene_list)
gene_list=foldchanges
gene_list = sort(gene_list, decreasing = TRUE)

kk2=gseKEGG(gene_list,organism = 'hsa',nPerm=1000,pvalueCutoff = 1)
length(gene_list)

df.kk2=as.data.frame(kk2)
df.kk2=df.kk2[order(abs(df.kk2$enrichmentScore)),]
gseaplot(kk2, by = "runningScore", title = kk2$Description[1], geneSetID = 1)
head(kk2)

description_name="Cysteine and methionine metabolism"
wanted_pathways=c('Purine metabolism')
for (description_name in wanted_pathways){
  p=gseaplot2(kk2,  title = description_name, geneSetID = which(kk2$Description==description_name))
  
  filepath_name=paste0('~/workstation/MetabSubtype/tasks/MultiOmics/results/20240930_essay_figures/gsea/',description_name,'.pdf')
  pdf(filepath_name)
  print(p)
  dev.off()

}

```

# Mean Aggregate

```{r}

kegg_result=enrichKEGG(
  na.omit(df.test_results[['ENTREZID']]),
  organism = "hsa",
  keyType = "kegg",
  pvalueCutoff = 1,
  pAdjustMethod = "BH",
  minGSSize = 1,
  maxGSSize = 1000,
  qvalueCutoff = 0.2,
  use_internal_data = FALSE
)
all.kegg_table <- na.omit(as.data.frame(kegg_result))

all.kegg_table$FoldEnrich <- apply(all.kegg_table, 1, 
                               function(x) as.numeric(unlist(strsplit(x[['GeneRatio']], '[/]'))[1])/
                                 as.numeric(unlist(strsplit(x[['GeneRatio']], '[/]'))[2])*
                                 as.numeric(unlist(strsplit(x[['BgRatio']], '[/]'))[2])/
                                 as.numeric(unlist(strsplit(x[['BgRatio']], '[/]'))[1]))
all.kegg_table$symbol=apply(all.kegg_table,1,get_symbols)
dim(all.kegg_table)
```

```{r}

##### Mean Aggregate #####  
dirpath="~/workstation/MetabSubtype/tasks/MultiOmics/results/20240930_essay_figures/rna_pathway_heatmap/"
# setwd(dirpath)
class_label='kmeans_2_clusters'
df.use_sample=df.sample
df.use=merge(v_corrected.edger,df.cluster_result[,class_label,drop=FALSE],by="row.names")
row.names(df.use)=df.use[[1]]
df.use=df.use[,2:ncol(df.use)]

pathway_matrix=df.use %>% group_by(!!sym(class_label)) %>% summarise_all(mean)
dim(pathway_matrix)
colnames(pathway_matrix)
# Row Name Specified
df.pathway_fc=as.data.frame(pathway_matrix)
row.names(df.pathway_fc)=df.pathway_fc[[1]]
df.pathway_fc=df.pathway_fc[,2:ncol(df.pathway_fc)]
df.pathway_fc['fc',]=df.pathway_fc['2',]/df.pathway_fc['1',]
df.pathway_fc=t(df.pathway_fc)
df.pathway_fc=as.data.frame(df.pathway_fc)
df.pathway_fc
colnames(df.pathway_fc)
df.pathway_fc[['fc']]
df.pathway_fc['log2fc']=sapply(df.pathway_fc[['fc']],log2)
pvalue.kmeans_pathway=pvalue_by_wilcox(df.use,rna_num,class_label)
pvalue.kmeans_pathway
match(pvalue.kmeans_pathway[['Metabolites']],rownames(df.pathway_fc))
df.pathway_fc$pvalue=pvalue.kmeans_pathway[match(pvalue.kmeans_pathway[['Metabolites']],rownames(df.pathway_fc)),'pvalue']
df.pathway_fc$is_sig=df.pathway_fc$pvalue<=5e-2

pvalue_cutoff=1
use_row_ha=FALSE
col_split=TRUE
pathway_names=unique(kegg_table$Description)
pathway_name=pathway_names[8]


for (pathway_name in pathway_names){
  # Get Pathway CPDs
    rnas <- unlist(strsplit(kegg_table[['geneID']], "[/]"))
    queries=df.test_results[match(rnas,df.test_results$ENTREZID),'SYMBOL']  
    row_ha=rowAnnotation(sig=df.test_results[df.test_results$SYMBOL %in% queries,'is_sig'],col=list(sig=c('TRUE'='yellow','FALSE'='white')))
  mat=as.matrix(df.test_results[df.test_results$SYMBOL %in% queries,'log2fc',drop=FALSE])
  rownames(mat)=df.test_results[match(rownames(mat),df.test_results$ENSEMBL),'SYMBOL']
  # mat=mat[order(mat),,drop=FALSE]
  mat=mat[order(rownames(mat)),'log2fc',drop=FALSE]
  bk=c(-3,0,3)
  col_fun<-colorRamp2(
    bk,
    c("#1D91C0", "white", "#E31A1C"))
  p=ComplexHeatmap::pheatmap(mat,
                           name = pathway_name,
                           cluster_cols = F,
                           cluster_rows = F,
                           cellheight = 10,
                           cellwidth = 40,
                           col = col_fun,
                           right_annotation=row_ha
                           # scale="col"
                           
  )
  # print(p)
  # Sys.sleep(3)
  pathway_name=str_replace_all(pathway_name,'/','_')
  pathway_name=str_replace_all(pathway_name,',','_')
  pathway_name=str_replace_all(pathway_name,'\\(','_')
  pathway_name=str_replace_all(pathway_name,'\\)','_')
  filepath=paste(dirpath,pathway_name,'.pdf',sep='')
  filepath=str_replace_all(filepath,'  ',' ')
  if (pathway_name=='Purine metabolism'){
    pdf(filepath,5,30)
  }else{
    pdf(filepath,5, 30)
  }
  draw(p)
  dev.off()

}

```

```{r}
df.test_results[df.test_results$ENSEMBL=='ENSG00000141959',]
na.omit(df.test_results[df.test_results$ENTREZID=='5211',])
```

## Manually Selected

```{r}
rnas.glycolysis.entrezid=c('5211','2821','2203','8789','226','5211','5212','5213')
rnas.cysteine=c('')

pathway_name='glycolysis'
rnas <- rnas.glycolysis
queries=df.test_results[match(rnas.glycolysis.entrezid,df.test_results$ENTREZID),'SYMBOL']  
row_ha=rowAnnotation(sig=df.test_results[df.test_results$SYMBOL %in% queries,'is_sig'],col=list(sig=c('TRUE'='yellow','FALSE'='white')))
mat=as.matrix(df.test_results[df.test_results$SYMBOL %in% queries,'log2fc',drop=FALSE])
rownames(mat)=df.test_results[match(rownames(mat),df.test_results$ENSEMBL),'SYMBOL']
# mat=mat[order(mat),,drop=FALSE]
bk=c(-1,0,1)
col_fun<-colorRamp2(
  bk,
  c("#1D91C0", "white", "#E31A1C"))
p=ComplexHeatmap::pheatmap(mat,
                         name = pathway_name,
                         cluster_cols = F,
                         cluster_rows = F,
                         cellheight = 10,
                         cellwidth = 40,
                         col = col_fun,
                         right_annotation=row_ha
                         # scale="col"
                         
)
# print(p)
# Sys.sleep(3)
pathway_name=str_replace_all(pathway_name,'/','_')
pathway_name=str_replace_all(pathway_name,',','_')
pathway_name=str_replace_all(pathway_name,'\\(','_')
pathway_name=str_replace_all(pathway_name,'\\)','_')
filepath=paste(dirpath,pathway_name,'.pdf',sep='')
filepath=str_replace_all(filepath,'  ',' ')
if (pathway_name=='Purine metabolism'){
  pdf(filepath,5,10)
}else{
  pdf(filepath,5, 5)
}
draw(p)
dev.off()
```

### Glycolysis

```{r}

pathway_name='glycolysis'
pathway_id <- "hsa00010"
# 获取通路信息
pathway_info <- keggGet(pathway_id)
# 提取基因信息
genes <- pathway_info[[1]]$GENE
# 将基因ID和名称分离
gene_ids <- genes[seq(1, length(genes), 2)]
gene_names <- genes[seq(2, length(genes), 2)]

# Filter
rnas <- df.test_results[abs(df.test_results$log2fc)>log2(1.2)&(df.test_results$pvalue<5e-2)&(df.test_results$ENTREZID %in% gene_ids),'ENTREZID']

queries=df.test_results[match(rnas,df.test_results$ENTREZID),'SYMBOL']  
row_ha=rowAnnotation(sig=df.test_results[df.test_results$SYMBOL %in% queries,'is_sig'],col=list(sig=c('TRUE'='yellow','FALSE'='white')))
mat=as.matrix(df.test_results[df.test_results$SYMBOL %in% queries,'log2fc',drop=FALSE])
rownames(mat)=df.test_results[match(rownames(mat),df.test_results$ENSEMBL),'SYMBOL']
# mat=mat[order(mat),,drop=FALSE]
bk=c(-1.5,0,1.5)
col_fun<-colorRamp2(
  bk,
  c("#1D91C0", "white", "#E31A1C"))
p=ComplexHeatmap::pheatmap(mat,
                         name = pathway_name,
                         cluster_cols = F,
                         cluster_rows = F,
                         cellheight = 10,
                         cellwidth = 40,
                         col = col_fun,
                         right_annotation=row_ha
                         # scale="col"
                         
)
# print(p)
# Sys.sleep(3)
pathway_name=str_replace_all(pathway_name,'/','_')
pathway_name=str_replace_all(pathway_name,',','_')
pathway_name=str_replace_all(pathway_name,'\\(','_')
pathway_name=str_replace_all(pathway_name,'\\)','_')
filepath=paste(dirpath,pathway_name,'.pdf',sep='')
filepath=str_replace_all(filepath,'  ',' ')
if (pathway_name=='Purine metabolism'){
  pdf(filepath,5,10)
}else{
  pdf(filepath,5, 5)
}
draw(p)
dev.off()
df.test_results[df.test_results$ENTREZID %in% rnas,]
```

### Pentose

```{r}

pathway_name='pentose'
pathway_id <- "hsa00030"
# 获取通路信息
pathway_info <- keggGet(pathway_id)
# 提取基因信息
genes <- pathway_info[[1]]$GENE
# 将基因ID和名称分离
gene_ids <- genes[seq(1, length(genes), 2)]
gene_names <- genes[seq(2, length(genes), 2)]

# Filter
rnas <- df.test_results[abs(df.test_results$log2fc)>log2(1.2)&(df.test_results$pvalue<5e-2)&(df.test_results$ENTREZID %in% gene_ids),'ENTREZID']

queries=df.test_results[match(rnas,df.test_results$ENTREZID),'SYMBOL']  
row_ha=rowAnnotation(sig=df.test_results[df.test_results$SYMBOL %in% queries,'is_sig'],col=list(sig=c('TRUE'='yellow','FALSE'='white')))
mat=as.matrix(df.test_results[df.test_results$SYMBOL %in% queries,'log2fc',drop=FALSE])
rownames(mat)=df.test_results[match(rownames(mat),df.test_results$ENSEMBL),'SYMBOL']
# mat=mat[order(mat),,drop=FALSE]
bk=c(-1.5,0,1.5)
col_fun<-colorRamp2(
  bk,
  c("#1D91C0", "white", "#E31A1C"))
p=ComplexHeatmap::pheatmap(mat,
                         name = pathway_name,
                         cluster_cols = F,
                         cluster_rows = F,
                         cellheight = 10,
                         cellwidth = 40,
                         col = col_fun,
                         right_annotation=row_ha
                         # scale="col"
                         
)
# print(p)
# Sys.sleep(3)
pathway_name=str_replace_all(pathway_name,'/','_')
pathway_name=str_replace_all(pathway_name,',','_')
pathway_name=str_replace_all(pathway_name,'\\(','_')
pathway_name=str_replace_all(pathway_name,'\\)','_')
filepath=paste(dirpath,pathway_name,'.pdf',sep='')
filepath=str_replace_all(filepath,'  ',' ')
if (pathway_name=='Purine metabolism'){
  pdf(filepath,5,10)
}else{
  pdf(filepath,5, 5)
}
draw(p)
dev.off()
df.test_results[df.test_results$ENTREZID %in% rnas,]
```

### Methionine

```{r}

pathway_name='methionine'
pathway_id <- "hsa00270"
# 获取通路信息
pathway_info <- keggGet(pathway_id)
# 提取基因信息
genes <- pathway_info[[1]]$GENE
# 将基因ID和名称分离
gene_ids <- genes[seq(1, length(genes), 2)]
gene_names <- genes[seq(2, length(genes), 2)]

df.test_results[df.test_results$ENTREZID %in% gene_ids,]
# Filter
rnas <- df.test_results[abs(df.test_results$log2fc)>log2(1)&(df.test_results$pvalue<5e-2)&(df.test_results$ENTREZID %in% gene_ids),'ENTREZID']

queries=df.test_results[match(rnas,df.test_results$ENTREZID),'SYMBOL']  
row_ha=rowAnnotation(sig=df.test_results[df.test_results$SYMBOL %in% queries,'is_sig'],col=list(sig=c('TRUE'='yellow','FALSE'='white')))
mat=as.matrix(df.test_results[df.test_results$SYMBOL %in% queries,'log2fc',drop=FALSE])
rownames(mat)=df.test_results[match(rownames(mat),df.test_results$ENSEMBL),'SYMBOL']
# mat=mat[order(mat),,drop=FALSE]
bk=c(-2,0,2)
col_fun<-colorRamp2(
  bk,
  c("#1D91C0", "white", "#E31A1C"))
p=ComplexHeatmap::pheatmap(mat,
                         name = pathway_name,
                         cluster_cols = F,
                         cluster_rows = F,
                         cellheight = 10,
                         cellwidth = 40,
                         col = col_fun,
                         right_annotation=row_ha
                         # scale="col"
                         
)
print(p)
# Sys.sleep(3)
pathway_name=str_replace_all(pathway_name,'/','_')
pathway_name=str_replace_all(pathway_name,',','_')
pathway_name=str_replace_all(pathway_name,'\\(','_')
pathway_name=str_replace_all(pathway_name,'\\)','_')
filepath=paste(dirpath,pathway_name,'.pdf',sep='')
filepath=str_replace_all(filepath,'  ',' ')
if (pathway_name=='Purine metabolism'){
  pdf(filepath,5,10)
}else{
  pdf(filepath,5, 5)
}
draw(p)
dev.off()
df.test_results[df.test_results$ENTREZID %in% rnas,]
```

### Purine

```{r}


pathway_name='purine'
pathway_id <- "hsa00230"
# 获取通路信息
pathway_info <- keggGet(pathway_id)
# 提取基因信息
genes <- pathway_info[[1]]$GENE
# 将基因ID和名称分离
gene_ids <- genes[seq(1, length(genes), 2)]
gene_names <- genes[seq(2, length(genes), 2)]

# Filter
rnas <- df.test_results[abs(df.test_results$log2fc)>log2(1.2)&(df.test_results$pvalue<5e-2)&(df.test_results$ENTREZID %in% gene_ids),'ENTREZID']

queries=df.test_results[match(rnas,df.test_results$ENTREZID),'SYMBOL']  
row_ha=rowAnnotation(sig=df.test_results[df.test_results$SYMBOL %in% queries,'is_sig'],col=list(sig=c('TRUE'='yellow','FALSE'='white')))
mat=as.matrix(df.test_results[df.test_results$SYMBOL %in% queries,'log2fc',drop=FALSE])
rownames(mat)=df.test_results[match(rownames(mat),df.test_results$ENSEMBL),'SYMBOL']
# mat=mat[order(mat),,drop=FALSE]
bk=c(-1.5,0,1.5)
col_fun<-colorRamp2(
  bk,
  c("#1D91C0", "white", "#E31A1C"))
p=ComplexHeatmap::pheatmap(mat,
                         name = pathway_name,
                         cluster_cols = F,
                         cluster_rows = F,
                         cellheight = 10,
                         cellwidth = 40,
                         col = col_fun,
                         right_annotation=row_ha
                         # scale="col"
                         
)
# print(p)
# Sys.sleep(3)
pathway_name=str_replace_all(pathway_name,'/','_')
pathway_name=str_replace_all(pathway_name,',','_')
pathway_name=str_replace_all(pathway_name,'\\(','_')
pathway_name=str_replace_all(pathway_name,'\\)','_')
filepath=paste(dirpath,pathway_name,'.pdf',sep='')
filepath=str_replace_all(filepath,'  ',' ')
if (pathway_name=='Purine metabolism'){
  pdf(filepath,5,10)
}else{
  pdf(filepath,5, 5)
}
draw(p)
dev.off()
df.test_results[df.test_results$ENTREZID %in% rnas,]
df.test_results[df.test_results$ENTREZID %in% rnas,c('SYMBOL','ENTREZID')]
```

## Heatmap

```{r}

rnas.glycolysis.ensembl=df.test_results[match(rnas.glycolysis.entrezid,df.test_results$ENTREZID),'ENSEMBL']
rnas.glycolysis.symbol=df.test_results[match(rnas.glycolysis.entrezid,df.test_results$ENTREZID),'SYMBOL']

target_cols=rnas.glycolysis.ensembl
target_cols.symbol=rnas.glycolysis.symbol
class_label='kmeans_2_clusters'
df.sample_cluster$kmeans_2_clusters=as.factor(df.sample_cluster[['kmeans_2_clusters']])
loaddata=merge(v_corrected.edger,df.cluster_result[,class_label,drop=FALSE],by="row.names")
rownames(loaddata)=loaddata[,1]
loaddata=loaddata[2:ncol(loaddata)]
loaddata=loaddata[,c(target_cols,class_label)]
colnames(loaddata)=c(df.test_results[match(colnames(loaddata)[1:(ncol(loaddata)-1)],df.test_results$ENSEMBL),'SYMBOL'],class_label)
loaddata[idx]=0
draw_heatmap(loaddata[!is.na(loaddata[class_label]),],target_cols.symbol,class_label,class_label,FALSE)
```

```{r}
df.test_results[rnas.glycolysis.ensembl,]
```

```{r}

wilcox.test(loaddata[['']] ~ loaddata[,class_label], data = df.test, exact = FALSE)

```

## Volcano

```{r}

pathway_name='glycolysis'
# 指定目标KEGG通路，例如hsa04110（自噬通路）
pathway_id <- "hsa00010"
# 获取通路信息
pathway_info <- keggGet(pathway_id)
# 提取基因信息
genes <- pathway_info[[1]]$GENE
# 将基因ID和名称分离
gene_ids <- genes[seq(1, length(genes), 2)]
gene_names <- genes[seq(2, length(genes), 2)]

queries=df.test_results[match(gene_ids,df.test_results$ENTREZID),'SYMBOL'] 

volcano.test_results=df.test_results
colnames(volcano.test_results)[colnames(volcano.test_results) == "fc"] ="FC"
colnames(volcano.test_results)[colnames(volcano.test_results) == "log2fc"] ="log2FC"

colnames(volcano.test_results)[colnames(volcano.test_results) == "SYMBOL"] ="Metabolites"

volcano.test_results=volcano.test_results[volcano.test_results$Metabolites %in% queries,]
rownames(volcano.test_results)=volcano.test_results$SYMBOL

draw_volcano(volcano.test_results,0.05,2)
```

```{r}
volcano.test_results <- volcano.test_results[order(-abs(volcano.test_results$log2FC),volcano.test_results$pvalue), ]
volcano.test_results[1:20,c('ENTREZID','Metabolites')]
```
